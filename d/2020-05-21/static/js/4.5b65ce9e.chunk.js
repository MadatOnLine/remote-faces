(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[4],{101:function(e,t,n){"use strict";n.r(t),n.d(t,"SingleRoom",(function(){return re}));var r=n(3),a=n(0),c=n.n(a),i=(n(65),n(5)),o=function(e,t){try{window.localStorage.setItem(e,t)}catch(n){console.info("Failed to save string to localStorage",n)}},u=function(e){try{return window.localStorage.getItem(e)||""}catch(t){return""}},s=n(36),d=n(42),l=n(62),f=(n(69),n(2)),m=n(61),p=n(37),v=n(1),b=n.n(v),O=n(49),g=n(63),k=n(40),h=n(38),j=function(){var e=Object(f.a)(b.a.mark((function e(t,n){var r,a,c,i,o,u,s,d,l,f,m;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"===typeof ImageCapture){e.next=21;break}return r=new ImageCapture(n),e.next=4,Object(h.a)(2e3);case 4:return e.prev=4,e.next=7,r.takePhoto();case 7:return c=e.sent,e.next=10,createImageBitmap(c);case 10:a=e.sent,e.next=18;break;case 13:return e.prev=13,e.t0=e.catch(4),e.next=17,r.grabFrame();case 17:a=e.sent;case 18:return i=a.width,o=a.height,e.abrupt("return",{srcImg:a,srcW:i,srcH:o});case 21:return(u=document.getElementById("internal-video")).style.display="block",s=u.srcObject,d=function(){u.srcObject=s},u.srcObject=t,e.next=28,Object(h.a)(2e3);case 28:return l=u,f=u.videoWidth,m=u.videoHeight,e.abrupt("return",{srcImg:l,srcW:f,srcH:m,revert:d});case 32:case"end":return e.stop()}}),e,null,[[4,13]])})));return function(t,n){return e.apply(this,arguments)}}(),y=function(){var e=Object(f.a)(b.a.mark((function e(t){var n,a,c,i,o,u,s,d,l,f,m,p,v,O,g,k,h,y,E;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{video:{deviceId:t}}:{video:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return a=e.sent,c=a.getVideoTracks(),i=Object(r.a)(c,1),o=i[0],u=document.getElementById("internal-canvas"),s=u.getContext("2d"),d=72,l=72,u.width=d,u.height=l,e.next=13,j(a,o);case 13:return f=e.sent,m=f.srcImg,p=f.srcW,v=f.srcH,O=f.revert,g=Math.max(d/p,l/v),k=Math.min(p,d/g),h=Math.min(v,l/g),y=(p-k)/2,E=(v-h)/2,s.drawImage(m,y,E,k,h,0,0,d,l),O&&O(),o.stop(),e.abrupt("return",u.toDataURL("image/jpeg"));case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),E=function(e){return Object(k.a)(e)&&"string"===typeof e.image&&function(e){return Object(k.a)(e)&&"string"===typeof e.nickname&&"string"===typeof e.message&&"boolean"===typeof e.liveMode}(e.info)},I=n(39),w=n(98),C=n(99),x=n(43),S=function(){var e=Object(f.a)(b.a.mark((function e(t){var n,a,c,i,o,u;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{audio:{deviceId:t}}:{audio:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return a=e.sent,c=a.getAudioTracks(),i=Object(r.a)(c,1),o=i[0],e.next=7,o.applyConstraints({echoCancellation:!0,echoCancellationType:{ideal:"system"},noiseSuppression:{ideal:!0}});case 7:return u=function(){o.stop()},e.abrupt("return",{stream:a,dispose:u});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),T=function(e,t,n){var r=t||new MediaStream;return r.addTrack(e),r.dispatchEvent(new MediaStreamTrackEvent("addtrack",{track:e})),e.addEventListener("ended",(function(){r.removeTrack(e),0===r.getTracks().length&&n()})),r},M=c.a.memo((function(e){var t=e.image,n=e.nickname,r=e.statusMesg,a=e.obsoleted,i=e.liveMode,o=e.stream,u=e.speakerOn;return c.a.createElement("div",{className:"FaceImages-card",style:{opacity:a?.2:1}},i&&!a&&o?c.a.createElement("video",{className:"FaceImages-photo",ref:function(e){e&&e.srcObject!==o&&(e.srcObject=o)},autoPlay:!0,playsInline:!0,muted:!u}):c.a.createElement("img",{src:t||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQI12NgYAAAAAMAASDVlMcAAAAASUVORK5CYII=",className:"FaceImages-photo",alt:"myself"}),c.a.createElement("div",{className:"FaceImages-name"},n),c.a.createElement("div",{className:"FaceImages-mesg"},r),i&&!a&&o&&c.a.createElement("div",{className:"FaceImages-live-indicator",title:"Live Mode On"},"\u25c9"),i&&!a&&!o&&c.a.createElement("div",{className:"FaceImages-live-indicator",title:"Live Mode Available"},"\u25ce"))})),N=c.a.memo((function(e){var t=e.roomId,n=e.userId,i=e.nickname,o=e.statusMesg,u=e.liveMode,d=e.micOn,l=e.speakerOn,v=e.videoDeviceId,O=e.audioDeviceId,k=function(e,t,n,c,i,o){var u=Object(a.useState)(),d=Object(r.a)(u,2),l=d[0],v=d[1],O=Object(a.useState)([]),k=Object(r.a)(O,2),h=k[0],j=k[1],I=Object(a.useState)(),w=Object(r.a)(I,2),C=w[0],x=w[1];if(C)throw C;var S=Object(a.useRef)();Object(s.e)(e,t,Object(a.useCallback)(function(){var e=Object(g.a)(b.a.mark((function e(){return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(S.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,S.current;case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),[]));var T=Object(s.a)(e,t);return Object(s.b)(e,t,Object(a.useCallback)((function(e,t){if(E(e)){var n=Object(p.a)(Object(p.a)({},e),{},{userId:t.userId,received:Date.now(),obsoleted:!1,peerIndex:t.peerIndex});j((function(e){return e.find((function(e){return e.userId===n.userId}))?e.map((function(e){return e.userId===n.userId?n:e})):[].concat(Object(m.a)(e),[n])}))}}),[])),Object(s.d)(e,t,Object(a.useCallback)((function(e){if(e&&"CONNECTION_CLOSED"===e.type){var t=e.peerIndex;j((function(e){var n=!1,r=e.map((function(e){return e.peerIndex===t?(n=!0,Object(p.a)(Object(p.a)({},e),{},{obsoleted:!0})):e}));return n?r:e}))}}),[])),Object(a.useEffect)((function(){var e,t=function(){var e=Date.now()-12e4,t=Date.now()-6e5;j((function(n){var r=!1,a=n.map((function(n){return n.received<e&&!n.obsoleted?(r=!0,Object(p.a)(Object(p.a)({},n),{},{obsoleted:!0})):n.received<t&&n.obsoleted?(r=!0,null):n})).filter((function(e){return e}));return r?a:n}))},r=function(){var a=Object(f.a)(b.a.mark((function a(){var u,s;return b.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,t(),a.next=4,y(o);case 4:u=a.sent,v(u),T(s={image:u,info:{nickname:n,message:c,liveMode:i}}),S.current=s,a.next=15;break;case 12:a.prev=12,a.t0=a.catch(0),x(a.t0);case 15:e=setTimeout(r,12e4);case 16:case"end":return a.stop()}}),a,null,[[0,12]])})));return function(){return a.apply(this,arguments)}}();return r(),function(){clearTimeout(e)}}),[e,t,o,n,c,i,T]),{myImage:l,roomImages:h}}(t,n,i,o,u,v),h=k.myImage,j=k.roomImages,N=function(e,t,n,c,i,o,u){var d=Object(a.useState)(null),l=Object(r.a)(d,2),m=l[0],v=l[1],O=Object(a.useState)({}),g=Object(r.a)(O,2),k=g[0],h=g[1],j=Object(a.useRef)(!0);Object(a.useEffect)((function(){j.current=!1}),[]);var y=Object(a.useCallback)(function(){var e=Object(f.a)(b.a.mark((function e(t,n){var r;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0="video"===t.kind,!e.t0){e.next=5;break}return e.next=4,Object(x.c)(t);case 4:e.t0=!e.sent;case 5:if(!e.t0){e.next=7;break}return e.abrupt("return");case 7:r=function(){j.current&&h((function(e){var t=n.userId;e[t];return Object(w.a)(e,[t].map(C.a))}))},h((function(e){var a=e[n.userId],c=T(t,a,r);return a===c?e:Object(p.a)(Object(p.a)({},e),{},Object(I.a)({},n.userId,c))}));case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),[]),E=Object(s.c)(e,t,y,n?"faceVideo":void 0),M=E.addTrack,N=E.removeTrack,L=Object(s.c)(e,t,y,c?"faceAudio":void 0),A=L.addTrack,D=L.removeTrack;return Object(a.useEffect)((function(){var e=null;return n&&M&&N&&Object(f.a)(b.a.mark((function t(){var n,a,c,i,u,s,d;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(x.a)(o);case 2:n=t.sent,a=n.stream,c=n.dispose,i=a.getVideoTracks(),u=Object(r.a)(i,1),s=u[0],M(s),d=function(){j.current&&v(null)},v((function(e){return T(s,e,d)})),e=function(){N(s),c(),s.dispatchEvent(new Event("ended"))};case 10:case"end":return t.stop()}}),t)})))(),function(){e&&e()}}),[e,n,o,M,N]),Object(a.useEffect)((function(){var e=null;return c&&A&&D&&Object(f.a)(b.a.mark((function t(){var n,a,c,i,o,s,d;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,S(u);case 2:n=t.sent,a=n.stream,c=n.dispose,i=a.getAudioTracks(),o=Object(r.a)(i,1),s=o[0],A(s),d=function(){j.current&&v(null)},v((function(e){return T(s,e,d)})),e=function(){D(s),c(),s.dispatchEvent(new Event("ended"))};case 10:case"end":return t.stop()}}),t)})))(),function(){e&&e()}}),[e,c,u,A,D]),Object(a.useEffect)((function(){if(m){m.getAudioTracks().forEach((function(e){e.enabled=i}));var e=function(e){var t=e.track;"audio"===t.kind&&(t.enabled=i)};return m.addEventListener("addtrack",e),function(){m.removeEventListener("addtrack",e)}}}),[m,i]),{faceStream:m,faceStreamMap:k}}(t,n,u,u,d,v,O),L=N.faceStream,A=N.faceStreamMap;return c.a.createElement("div",{className:"FaceImage-container"},c.a.createElement(M,{image:h,nickname:i,statusMesg:o,liveMode:u,stream:L||void 0}),j.map((function(e){return c.a.createElement(M,{key:e.userId,image:e.image,nickname:e.info.nickname,statusMesg:e.info.message,obsoleted:e.obsoleted,liveMode:e.info.liveMode,stream:u&&A[e.userId]||void 0,speakerOn:l})})))})),L=n(70),A=n.n(L),D=(n(71),n(4)),P=function(e,t){var n=t[1]-e[1];return 0===n?e[0].length-t[0].length:n},R=function(e,t,n){var c=Object(a.useRef)([]),i=Object(a.useState)([]),o=Object(r.a)(i,2),u=o[0],d=o[1],l=Object(a.useCallback)((function(e){if(!c.current.some((function(t){return t.messageId===e.messageId})))if(c.current.unshift(e),c.current.length>1e3&&c.current.pop(),e.chatInReplyTo){var t=e.chatText,n=e.chatInReplyTo;d((function(e){return e.map((function(e){if(e.messageId===n){var r=new Map(e.replies);r.set(t,(r.get(t)||0)+1);var a=Object(m.a)(r.entries());return a.sort(P),Object(p.a)(Object(p.a)({},e),{},{replies:a})}return e}))}))}else{var r={messageId:e.messageId,nickname:e.nickname,createdAt:e.createdAt,text:e.chatText,replies:[],time:new Date(e.createdAt).toLocaleString().split(" ")[1].slice(0,-3)};d((function(e){var t=[r].concat(Object(m.a)(e));return t.length>100&&t.pop(),t.sort((function(e,t){return t.createdAt-e.createdAt})),t}))}}),[]);Object(s.e)(e,t,Object(a.useCallback)(function(){var e=Object(g.a)(b.a.mark((function e(){var t;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=c.current.length-1;case 1:if(!(t>=0)){e.next=9;break}return e.next=4,Object(O.a)(Object(h.a)(5e3*Math.random()));case 4:return e.next=6,c.current[t];case 6:t-=1,e.next=1;break;case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),[]));var f=Object(s.a)(e,t);return Object(s.b)(e,t,Object(a.useCallback)((function(e){var t;(t=e,!Object(k.a)(t)||"string"!==typeof t.userId||"string"!==typeof t.nickname||"string"!==typeof t.messageId||"number"!==typeof t.createdAt||"string"!==typeof t.chatText||"undefined"!==typeof t.chatInReplyTo&&"string"!==typeof t.chatInReplyTo)||l(e)}),[l])),{chatList:u,sendChat:Object(a.useCallback)((function(e){var r={userId:t,nickname:n,messageId:Object(D.f)(),createdAt:Date.now(),chatText:e};f(r),l(r)}),[f,t,n,l]),replyChat:Object(a.useCallback)((function(e,r){var a={userId:t,nickname:n,messageId:Object(D.f)(),createdAt:Date.now(),chatText:e,chatInReplyTo:r};f(a),l(a)}),[f,t,n,l])}},U=(n(72),n(48)),_=U.b,F=n(76),W=n.n(F),V=n(78),z=n.n(V),B=(n(93),{toolbar:["specialCharacters","|","bold","italic","link","blockQuote","|","imageUpload","insertTable","mediaEmbed","|","undo","redo"],balloonToolbar:["heading","|","bulletedList","numberedList","indent","outdent"],link:{addTargetToExternalLinks:!0}}),H=c.a.memo((function(e){var t=e.registerClear,n=e.onChange;return c.a.createElement(W.a,{editor:z.a,config:B,onInit:function(e){t((function(){e.setData("")})),function(e){e.plugins.get("SpecialCharacters").addItems("Emoji",[{title:"smiley face",character:"\ud83d\ude0a"},{title:"rocket",character:"\ud83d\ude80"},{title:"wind blowing face",character:"\ud83c\udf2c\ufe0f"},{title:"floppy disk",character:"\ud83d\udcbe"},{title:"heart",character:"\u2764\ufe0f"}])}(e)},onChange:function(e,t){var r=t.getData();n(r)}})})),G=c.a.memo((function(e){var t,n=e.item,i=e.replyChat,o=Object(a.useState)(!1),u=Object(r.a)(o,2),s=u[0],d=u[1],l=function(e){return i(e,n.messageId)};return c.a.createElement("li",{key:n.messageId,className:"MomentaryChat-listPart"},s&&c.a.createElement(_,{onSelect:function(e){l(e.native),d(!1)}}),c.a.createElement("div",{className:"MomentaryChat-listPart-header"},c.a.createElement("div",{className:"MomentaryChat-iconButton-container"},c.a.createElement("div",{className:"MomentaryChat-iconButton"},c.a.createElement("button",{type:"button",onClick:function(){d(!s)}},"+"))),c.a.createElement("span",{className:"MomentaryChat-nickname"},n.nickname||"No Name"),c.a.createElement("span",{className:"MomentaryChat-time"},n.time)),c.a.createElement("div",{className:"MomentaryChat-text ck-content",dangerouslySetInnerHTML:(t=n.text,{__html:A.a.sanitize(t,{ADD_ATTR:["target"]})})}),n.replies.map((function(e){var t=Object(r.a)(e,2),n=t[0],a=t[1];return c.a.createElement("button",{key:n,className:"MomentaryChat-icon",type:"button",onClick:function(){return l(n)}},n," ",a)})))})),J=c.a.memo((function(e){var t,n=e.chatList,r=e.replyChat,i=Object(a.useRef)(null),o=null===(t=n[0])||void 0===t?void 0:t.messageId;return Object(a.useEffect)((function(){i.current&&o&&(i.current.scrollTop=i.current.scrollHeight)}),[o]),c.a.createElement("ul",{className:"MomentaryChat-list",ref:i},n.map((function(e){return c.a.createElement(G,{key:e.messageId,item:e,replyChat:r})})))})),K=c.a.memo((function(e){var t=e.roomId,n=e.userId,i=e.nickname,o=Object(a.useRef)(null),u=R(t,n,i),s=u.chatList,d=u.sendChat,l=u.replyChat,f=Object(a.useRef)(),m=Object(a.useState)(""),p=Object(r.a)(m,2),v=p[0],b=p[1];return c.a.createElement("div",{className:"MomentaryChat-container",ref:o},c.a.createElement(J,{chatList:s,replyChat:l}),c.a.createElement("div",{className:"MomentaryChat-editor"},c.a.createElement(H,{registerClear:function(e){f.current=e},onChange:b})),c.a.createElement("div",{className:"MomentaryChat-button"},c.a.createElement("button",{type:"button",onClick:function(){v&&(d(v),b(""),f.current&&f.current())},disabled:!v},"Send")))})),Q=(n(94),c.a.memo((function(e){var t=e.initialText,n=e.onUpdate,i=e.buttonLabel,o=e.placeholder,u=e.clearOnUpdate,s=Object(a.useState)(t),d=Object(r.a)(s,2),l=d[0],f=d[1];return c.a.createElement("form",{onSubmit:function(e){e.preventDefault(),l&&(n(l),u&&f(""))}},c.a.createElement("input",{value:l,onChange:function(e){return f(e.target.value)},placeholder:o}),i&&c.a.createElement("button",{type:"submit",disabled:!l},i))}))),Y=c.a.memo((function(e){var t=e.initialNickname,n=e.emoji,i=e.onUpdateNickname,o=e.onUpdateStatusMesg,u=e.onUpdateEmoji,s=Object(a.useState)(!1),d=Object(r.a)(s,2),l=d[0],f=d[1];return c.a.createElement("div",{className:"UserProfile-container"},c.a.createElement("div",{className:"UserProfile-nickname"},c.a.createElement(Q,{initialText:t,onUpdate:i,placeholder:"Enter your name",buttonLabel:"Set"})),c.a.createElement("div",{className:"UserProfile-status-area"},c.a.createElement("div",{className:"UserProfile-emoji"},c.a.createElement("button",{type:"button",onClick:function(){f(!l)}},n?c.a.createElement(U.a,{emoji:n,size:10}):":)")),c.a.createElement("div",{className:"UserProfile-statusmesg"},c.a.createElement(Q,{initialText:"",onUpdate:o,placeholder:"Enter status message",buttonLabel:"Set"})),c.a.createElement("button",{type:"button",onClick:function(){u(null),o(""),f(!1)}},"Clear")),l&&c.a.createElement(_,{onSelect:function(e){u(e),f(!1)}}))})),Z=c.a.lazy((function(){return n.e(7).then(n.bind(null,102))})),q=c.a.lazy((function(){return n.e(8).then(n.bind(null,103))})),X=c.a.lazy((function(){return n.e(5).then(n.bind(null,104))})),$=u("nickname"),ee="true"!==u("config_hidden"),te=u("faceimage_video_device_id"),ne=u("faceimage_audio_device_id"),re=c.a.memo((function(e){var t=e.roomId,n=e.userId,u=Object(a.useState)($),f=Object(r.a)(u,2),m=f[0],p=f[1],v=Object(a.useState)(""),b=Object(r.a)(v,2),O=b[0],g=b[1],k=Object(a.useState)(null),h=Object(r.a)(k,2),j=h[0],y=h[1];Object(a.useEffect)((function(){Object(i.d)(t)}),[t]);var E=Object(l.b)(),I=Object(l.a)(),w=Object(a.useState)(te),C=Object(r.a)(w,2),x=C[0],S=C[1],T=Object(a.useState)(ne),M=Object(r.a)(T,2),L=M[0],A=M[1],D=Object(a.useState)(!1),P=Object(r.a)(D,2),R=P[0],U=P[1],_=Object(a.useState)(!1),F=Object(r.a)(_,2),W=F[0],V=F[1],z=Object(a.useState)(!1),B=Object(r.a)(z,2),H=B[0],G=B[1],J=Object(a.useState)(!1),Q=Object(r.a)(J,2),re=Q[0],ae=Q[1],ce=Object(a.useState)(!1),ie=Object(r.a)(ce,2),oe=ie[0],ue=ie[1],se=Object(a.useState)(!1),de=Object(r.a)(se,2),le=de[0],fe=de[1],me=Object(a.useState)(ee),pe=Object(r.a)(me,2),ve=pe[0],be=pe[1];Object(a.useEffect)((function(){o("config_hidden",ve?"false":"true")}),[ve]);var Oe=Object(s.d)(t,n);Object(d.a)(t,n);var ge="remote-faces://".concat(window.location.href.replace(/^https:\/\//,""));return c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:"SingleRoom-body"},c.a.createElement(N,{roomId:t,userId:n,videoDeviceId:x,audioDeviceId:L,nickname:m,statusMesg:"".concat((null===j||void 0===j?void 0:j.native)||"").concat(O),liveMode:R,micOn:W,speakerOn:H}),c.a.createElement("div",{className:"SingleRoom-2nd-column"},c.a.createElement(Y,{initialNickname:$,emoji:j,onUpdateNickname:function(e){p(e),o("nickname",e)},onUpdateStatusMesg:function(e){g(e)},onUpdateEmoji:function(e){y(e)}}),c.a.createElement("div",null,c.a.createElement("button",{type:"button",className:"SingleRoom-config-toggle",onClick:function(){return be((function(e){return!e}))}},"Setting",ve?c.a.createElement(c.a.Fragment,null,"\u25bc"):c.a.createElement(c.a.Fragment,null,"\u25b6")),ve&&c.a.createElement("div",{className:"SingleRoom-config"},c.a.createElement("div",null,"Link to this room:",c.a.createElement("input",{value:window.location.href,readOnly:!0}),"(Share this link with your colleagues)",c.a.createElement("a",{href:ge},"Open App")),c.a.createElement("div",null,"Select Camera:"," ",c.a.createElement("select",{value:x,onChange:function(e){S(e.target.value),o("faceimage_video_device_id",e.target.value)}},E.map((function(e){return c.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),c.a.createElement("div",null,"Select Mic:"," ",c.a.createElement("select",{value:L,onChange:function(e){A(e.target.value),o("faceimage_audio_device_id",e.target.value)}},I.map((function(e){return c.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),c.a.createElement("div",null,"Live Mode:"," ",c.a.createElement("button",{type:"button",onClick:function(){return U((function(e){return!e}))}},R?"Disable":"Enable"),R&&c.a.createElement(c.a.Fragment,null,"\u2714"),R&&c.a.createElement("div",null,c.a.createElement("label",null,c.a.createElement("input",{type:"checkbox",checked:W,onChange:function(e){return V(e.target.checked)}}),"Mic On"),c.a.createElement("label",null,c.a.createElement("input",{type:"checkbox",checked:H,onChange:function(e){return G(e.target.checked)}}),"Speaker On"))),c.a.createElement("div",null,"Screen Share:"," ",c.a.createElement("button",{type:"button",onClick:function(){return ae((function(e){return!e}))}},re?"Close":"Open"),re&&c.a.createElement(c.a.Fragment,null,"\u2714")),c.a.createElement("div",null,"Video Share:"," ",c.a.createElement("button",{type:"button",onClick:function(){return ue((function(e){return!e}))}},oe?"Close":"Open"),oe&&c.a.createElement(c.a.Fragment,null,"\u2714")),c.a.createElement("div",null,"Collab White Board:"," ",c.a.createElement("button",{type:"button",onClick:function(){return fe((function(e){return!e}))}},le?"Close":"Open"),le&&c.a.createElement(c.a.Fragment,null,"\u2714")),c.a.createElement("div",{className:"SingleRoom-status"},JSON.stringify(Oe)))),c.a.createElement(K,{roomId:t,userId:n,nickname:m})),c.a.createElement("div",{className:"SingleRoom-3rd-column"},re&&c.a.createElement(Z,{roomId:t,userId:n,nickname:m}),oe&&c.a.createElement(q,{roomId:t,userId:n,nickname:m}),le&&c.a.createElement(X,{roomId:t}))))}));t.default=re},36:function(e,t,n){"use strict";n.d(t,"d",(function(){return y})),n.d(t,"e",(function(){return E})),n.d(t,"a",(function(){return I})),n.d(t,"b",(function(){return w})),n.d(t,"c",(function(){return C}));var r=n(1),a=n.n(r),c=n(2),i=n(3),o=n(66),u=n(0),s=n(37),d=n(67),l=n.n(d),f=n(38),m=n(4),p=n(5),v=n(40),b=n(8),O=new WeakMap,g=function(e,t){if(O.has(e))return e;O.set(e,!0);var n=function(){var n=Object(c.a)(a.a.mark((function n(){var r;return a.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,Object(f.a)(5e3);case 2:!(r=t.getTransceivers().find((function(t){return t.receiver.track===e})))||"inactive"!==r.currentDirection&&"sendonly"!==r.currentDirection||(e.stop(),e.dispatchEvent(new Event("ended")));case 4:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();return e.addEventListener("mute",n),e},k=function(e){var t=Object(b.e)(e);return 10<=t&&t<=14},h=new Map,j=function(e,t,n){var r="".concat(e,"_").concat(t),i=h.get(r);if(!i){var o=new Set,u=new Set,d=new Set,O=new Set;i={room:function(e,t,n,r,i,o){var u=!1,d=null,O=Object(b.b)(),h=[],j=null,y=function(){if(!u){var e=O.getConnectedPeerIds().map(b.e);n({type:"CONNECTED_PEERS",peerIndexList:e})}},E=function(e){if(!u&&d&&d.id!==e&&!d.disconnected&&!O.hasConn(e)){console.log("connectPeer",e);var t=d.connect(e);L(t)}},I=function(e){if(!u){var n=O.getConnectedPeerIds();O.forEachConnectedConns((function(r){N(r,{userId:t,data:e,peers:n,mediaTypes:h})}))}},w=function(e,t){N(e,{SDP:t})},C=function(){var e=Object(c.a)(a.a.mark((function e(t,n){var r,c,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(v.a)(n)){e.next=2;break}return e.abrupt("return");case 2:if(!Object(v.a)(n.offer)){e.next=21;break}return r=n.offer,e.prev=4,e.next=7,t.peerConnection.setRemoteDescription(r);case 7:return R(t),e.next=10,t.peerConnection.createAnswer();case 10:return c=e.sent,e.next=13,t.peerConnection.setLocalDescription(c);case 13:w(t,{answer:c}),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),console.info("handleSDP offer failed",e.t0);case 19:e.next=38;break;case 21:if(!Object(v.a)(n.answer)){e.next=37;break}return i=n.answer,e.prev=23,e.next=26,t.peerConnection.setRemoteDescription(i);case 26:e.next=35;break;case 28:return e.prev=28,e.t1=e.catch(23),console.info("handleSDP answer failed",e.t1),e.next=33,Object(f.a)(30*Math.random()*1e3);case 33:U(t),R(t);case 35:e.next=38;break;case 37:console.warn("unknown SDP",n);case 38:case"end":return e.stop()}}),e,null,[[4,16],[23,28]])})));return function(t,n){return e.apply(this,arguments)}}(),x=function(e,t){"string"===typeof t&&O.setUserId(e,t)},S=function(){var e=Object(c.a)(a.a.mark((function e(t,n){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(n)||!n.every((function(e){return"string"===typeof e}))){e.next=5;break}return O.setMediaTypes(t,n),e.next=4,Object(f.a)(5e3);case 4:R(t);case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),T=function(e,t){var n=O.getUserId(e);if(n){var r={userId:n,peerIndex:Object(b.d)(e),mediaTypes:O.getMediaTypes(e)};try{i(t,r)}catch(a){console.warn("receiveData",a)}}},M=function(){var t=Object(c.a)(a.a.mark((function t(n,r){var c;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!u){t.next=2;break}return t.abrupt("return");case 2:return t.prev=2,t.t0=JSON,t.next=6,Object(m.a)(r,e.slice(b.a));case 6:if(t.t1=t.sent,c=t.t0.parse.call(t.t0,t.t1),console.log("decrypted payload",n.peer,c),Object(v.a)(c)){t.next=11;break}return t.abrupt("return");case 11:C(n,c.SDP),x(n,c.userId),S(n,c.mediaTypes),a=c.peers,Array.isArray(a)&&a.forEach((function(t){Object(b.f)(e,t)&&E(t)})),T(n,c.data),t.next=21;break;case 18:t.prev=18,t.t2=t.catch(2),console.info("Error in handlePayload",t.t2,r);case 21:case"end":return t.stop()}var a}),t,null,[[2,18]])})));return function(e,n){return t.apply(this,arguments)}}(),N=function(){var t=Object(c.a)(a.a.mark((function t(n,r){var c;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,Object(m.b)(JSON.stringify(r),e.slice(b.a));case 3:c=t.sent,n.send(c),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0),console.error("sendPayload",t.t0);case 10:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e,n){return t.apply(this,arguments)}}(),L=function(e){if(O.isConnected(e.peer))e.close();else{O.addConn(e),e.on("open",(function(){O.markConnected(e),console.log("dataConnection open",e),y();r((function(n){var r=O.getConnectedPeerIds();N(e,{userId:t,data:n,peers:r,mediaTypes:h})}))})),e.on("data",(function(t){return M(e,t)})),e.peerConnection.addEventListener("icegatheringstatechange",(function(){var t=e.peerConnection;"complete"===t.iceGatheringState&&(t.onicecandidate=function(){})}));var i=new WeakMap;e.peerConnection.addEventListener("negotiationneeded",Object(c.a)(a.a.mark((function t(){var n;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!i.has(e)){t.next=2;break}return t.abrupt("return");case 2:return i.set(e,!0),t.next=5,Object(f.a)(2e3);case 5:if(i.delete(e),O.isConnected(e.peer)){t.next=8;break}return t.abrupt("return");case 8:return t.next=10,e.peerConnection.createOffer();case 10:return n=t.sent,t.next=13,e.peerConnection.setLocalDescription(n);case 13:w(e,{offer:n});case 14:case"end":return t.stop()}}),t)})))),e.peerConnection.addEventListener("track",(function(t){var n=O.getUserId(e);if(n){var r={userId:n,peerIndex:Object(b.e)(e.peer),mediaTypes:O.getMediaTypes(e)};o(g(t.track,e.peerConnection),r)}})),e.on("close",(function(){if(O.delConn(e),console.log("dataConnection closed",e),n({type:"CONNECTION_CLOSED",peerIndex:Object(b.d)(e)}),y(),0===O.getConnectedPeerIds().length)D(!0);else if(k(e.peer)&&d&&!d.disconnected&&!k(d.id)){var t=30+Math.floor(60*Math.random());console.log("Disconnected seed peer: ".concat(Object(b.e)(e.peer),", reinit in ").concat(t,"sec...")),setTimeout(D,1e3*t)}}))}},A=function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;if(!u&&!d){O.clearAll();var a=10<=r&&r<=14,c=a?r:Object(m.e)();n({type:"INITIALIZING_PEER",peerIndex:c});var i=Object(b.c)(e,c);console.log("initMyPeer start",r,i);var o=new l.a(i,Object(s.a)(Object(s.a)({},Object(p.c)()||{}),{},{debug:3}));d=o,o.on("open",(function(){d=o,n({type:"CONNECTING_SEED_PEERS"});for(var t=10;t<=14;t+=1){var r=Object(b.c)(e,t);E(r)}})),o.on("error",(function(e){"unavailable-id"===e.type?(d=null,o.destroy(),t(r+1)):"peer-unavailable"===e.type||("disconnected"===e.type?(console.log("initMyPeer disconnected error",r,e),o.destroy()):"network"===e.type?console.log("initMyPeer network error",r,e):"server-error"===e.type?(console.log("initMyPeer server error",r,e),n({type:"SERVER_ERROR"})):(console.error("initMyPeer unknown error",r,e.type,e),n({type:"UNKNOWN_ERROR",err:e})))})),o.on("connection",(function(e){d===o?(console.log("new connection received",e),n({type:"NEW_CONNECTION",peerIndex:Object(b.d)(e)}),L(e)):e.close()})),o.on("disconnected",(function(){console.log("initMyPeer disconnected",r),setTimeout((function(){d!==o||o.destroyed||(console.log("initMyPeer reconnecting",r),n({type:"RECONNECTING"}),o.reconnect())}),5e3)})),o.on("close",(function(){d===o?(console.log("initMyPeer closed, re-initializing",r),d=null,setTimeout(t,2e4)):console.log("initMyPeer closed, ignoring",r)}))}};A();var D=function(t){if(d&&!d.disconnected){if(!t){if(k(d.id))return;for(var n=!0,r=10;r<=14;r+=1){var a=Object(b.c)(e,r);if(!O.isConnected(a)){n=!1;break}}if(n)return void y()}var c=d;d=null,c.destroy(),A()}},P=new WeakMap,R=function(e){var t=e.peerConnection.getSenders(),n=O.getMediaTypes(e);j&&j.getTracks().forEach((function(r){var a=P.get(r);j&&a&&n.includes(a)&&t.every((function(e){return e.track!==r}))&&e.peerConnection.addTrack(r,j)})),t.forEach((function(t){if(t.track){var r=P.get(t.track);r&&n.includes(r)||e.peerConnection.removeTrack(t)}})),t.some((function(e){return e.track&&!e.transport}))&&e.peerConnection.dispatchEvent(new Event("negotiationneeded"))},U=function(e){e.peerConnection.getSenders().forEach((function(t){t.track&&e.peerConnection.removeTrack(t)}))};return{broadcastData:I,acceptMediaTypes:function(e){(h=e).length?j||(j=new MediaStream,O.forEachConnectedConns((function(e){var t=O.getUserId(e);if(t){var n={userId:t,peerIndex:Object(b.e)(e.peer),mediaTypes:O.getMediaTypes(e)};e.peerConnection.getReceivers().forEach((function(t){o(g(t.track,e.peerConnection),n)}))}}))):j=null,I(null)},addTrack:function(e,t){j&&(P.set(t,e),j.addTrack(t),O.forEachConnsAcceptingMedia(e,(function(e){try{if(!j)return;e.peerConnection.addTrack(t,j)}catch(n){if("InvalidAccessError"!==n.name)throw n}})))},removeTrack:function(e,t){j&&j.removeTrack(t),O.forEachConnsAcceptingMedia(e,(function(e){var n=e.peerConnection.getSenders().find((function(e){return e.track===t}));n&&e.peerConnection.removeTrack(n)}))},dispose:function(){u=!0,d&&d.destroy()}}}(e,t,(function(e){o.forEach((function(t){t(e)}))}),(function(e){u.forEach((function(t){t(e)}))}),(function(e,t){d.forEach((function(n){n(e,t)}))}),(function(e,t){O.forEach((function(n){(0,n.listener)(e,t)}))})),networkStatusListeners:o,newPeerListeners:u,dataListeners:d,trackListeners:O,count:0},h.set(r,i)}if(n.networkStatusListener&&i.networkStatusListeners.add(n.networkStatusListener),n.newPeerListener&&i.newPeerListeners.add(n.newPeerListener),n.dataListener&&i.dataListeners.add(n.dataListener),n.trackListener){var j=new Set(Array.from(i.trackListeners).map((function(e){return e.mediaType}))),y=j.size;i.trackListeners.add(n.trackListener),j.add(n.trackListener.mediaType),y!==j.size&&i.room.acceptMediaTypes(Array.from(j))}i.count+=1;var E=i;return{broadcastData:i.room.broadcastData,addTrack:i.room.addTrack,removeTrack:i.room.removeTrack,unregister:function(){if(n.networkStatusListener&&E.networkStatusListeners.delete(n.networkStatusListener),n.newPeerListener&&E.newPeerListeners.delete(n.newPeerListener),n.dataListener&&E.dataListeners.delete(n.dataListener),n.trackListener){var e=new Set(Array.from(E.trackListeners).map((function(e){return e.mediaType}))),t=e.size;E.trackListeners.delete(n.trackListener),t!==(e=new Set(Array.from(E.trackListeners).map((function(e){return e.mediaType})))).size&&E.room.acceptMediaTypes(Array.from(e))}E.count-=1,E.count<=0&&(E.room.dispose(),h.delete(r))}}},y=function(e,t,n){var r=Object(u.useState)(),a=Object(i.a)(r,2),c=a[0],o=a[1];if(c&&"UNKNOWN_ERROR"===c.type)throw new Error("Network Error: ".concat(c.err.message));return Object(u.useEffect)((function(){return j(e,t,{networkStatusListener:function(e){o(e),n&&n(e)}}).unregister}),[e,t,n]),c},E=function(e,t,n){Object(u.useEffect)((function(){return j(e,t,{newPeerListener:function(){var e=Object(c.a)(a.a.mark((function e(t){var r,c,i,u,s,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,c=!1,e.prev=2,u=Object(o.a)(n());case 4:return e.next=6,u.next();case 6:return s=e.sent,r=s.done,e.next=10,s.value;case 10:if(d=e.sent,r){e.next=17;break}t(d);case 14:r=!0,e.next=4;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(2),c=!0,i=e.t0;case 23:if(e.prev=23,e.prev=24,r||null==u.return){e.next=28;break}return e.next=28,u.return();case 28:if(e.prev=28,!c){e.next=31;break}throw i;case 31:return e.finish(28);case 32:return e.finish(23);case 33:case"end":return e.stop()}}),e,null,[[2,19,23,33],[24,,28,32]])})));return function(t){return e.apply(this,arguments)}}()}).unregister}),[e,t,n])},I=function(e,t){var n=Object(u.useRef)(),r=Object(u.useCallback)((function(){n.current&&n.current.apply(n,arguments)}),[]);return Object(u.useEffect)((function(){var r=j(e,t,{});return n.current=r.broadcastData,r.unregister}),[e,t]),r},w=function(e,t,n){Object(u.useEffect)((function(){return j(e,t,{dataListener:n}).unregister}),[e,t,n])},C=function(e,t,n,r){var a=Object(u.useState)({}),c=Object(i.a)(a,2),o=c[0],s=c[1];return Object(u.useEffect)((function(){if(r){var a=j(e,t,{trackListener:{mediaType:r,listener:n}});return s({addTrack:function(e){return a.addTrack(r,e)},removeTrack:function(e){return a.removeTrack(r,e)}}),function(){s({}),a.unregister()}}}),[e,t,n,r]),o}},38:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(e){return new Promise((function(t){return setTimeout(t,e)}))}},40:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(e){return"object"===typeof e&&null!==e}},42:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(3),a=n(0),c=n(40),i=n(36),o=[],u=function(e){var t={};return o.forEach((function(n){n.roomId===e&&(t[n.userId]=n.nickname)})),t},s=function(e,t){var n=Object(a.useState)((function(){return u(e)})),s=Object(r.a)(n,2),d=s[0],l=s[1];return Object(i.b)(e,t,Object(a.useCallback)((function(t,n){if(r=t,Object(c.a)(r)&&Object(c.a)(r.info)&&"string"===typeof r.info.nickname){var r,a=o.findIndex((function(t){return t.roomId===e&&t.userId===n.userId})),i=Date.now();a>=0?(o[a].nickname!==t.info.nickname&&(o[a].nickname=t.info.nickname),o[a].lastUpdated=i):o.push({roomId:e,userId:n.userId,nickname:t.info.nickname,lastUpdated:i});for(var s=o.length-1;s>=0;s-=1)o[s].lastUpdated+6e5<i&&o.splice(s,1);l((function(t){var n=u(e),r=Object.keys(n);return r.length===Object.keys(t).length&&r.every((function(e){return n[e]===t[e]}))?t:n}))}}),[e])),d}},43:function(e,t,n){"use strict";n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return f}));var r=n(1),a=n.n(r),c=n(3),i=n(2),o=n(38),u=function(){var e=Object(i.a)(a.a.mark((function e(t){var n,r,i,o,u,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{video:{deviceId:t}}:{video:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return r=e.sent,i=r.getVideoTracks(),o=Object(c.a)(i,1),u=o[0],s=function(){u.stop()},e.abrupt("return",{stream:r,dispose:s});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),s=function(){var e=Object(i.a)(a.a.mark((function e(t){var n,r,i,u,s,d,l,f,m,p,v,b,O,g,k,h,j,y;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{video:{deviceId:t}}:{video:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return r=e.sent,i=r.getVideoTracks(),u=Object(c.a)(i,1),s=u[0],(d=document.getElementById("internal-video")).style.display="block",d.srcObject=r,e.next=10,Object(o.a)(1e3);case 10:return l=d.videoWidth,f=d.videoHeight,m=document.getElementById("internal-canvas"),p=m.getContext("2d"),72,72,m.width=72,m.height=72,v=Math.max(72/l,72/f),b=Math.min(l,72/v),O=Math.min(f,72/v),g=(l-b)/2,k=(f-O)/2,function e(){p.drawImage(d,g,k,b,O,0,0,72,72),h=setTimeout(e,1e3/15)}(),j=m.captureStream(),y=function(){d.style.display="none",clearTimeout(h),s.stop(),j.getVideoTracks()[0].stop()},e.abrupt("return",{stream:j,dispose:y});case 28:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),d=function(){var e=Object(i.a)(a.a.mark((function e(t){var n,r,c,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,(n=document.createElement("video")).srcObject=new MediaStream([t]),r=0;case 4:if(!(r<50)){e.next=14;break}return e.next=7,Object(o.a)(100);case 7:if(c=n.videoWidth,i=n.videoHeight,!(c>0&&i>0)){e.next=11;break}return e.abrupt("return",72===c&&72===i);case 11:r+=1,e.next=4;break;case 14:return e.abrupt("return",!0);case 17:return e.prev=17,e.t0=e.catch(0),e.abrupt("return",!0);case 20:case"end":return e.stop()}}),e,null,[[0,17]])})));return function(t){return e.apply(this,arguments)}}(),l=new WeakMap,f=function(e){if(l.has(e))return l.get(e);var t=d(e);return l.set(e,t),t}},62:function(e,t,n){"use strict";n.d(t,"b",(function(){return d})),n.d(t,"a",(function(){return l}));var r=n(1),a=n.n(r),c=n(2),i=n(3),o=n(0),u=function(){var e=Object(c.a)(a.a.mark((function e(){var t,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:return t=e.sent,n=t.filter((function(e){return"videoinput"===e.kind})).map((function(e){return{label:e.label,deviceId:e.deviceId}})),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",[]);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),s=function(){var e=Object(c.a)(a.a.mark((function e(){var t,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:return t=e.sent,n=t.filter((function(e){return"audioinput"===e.kind})).map((function(e){return{label:e.label,deviceId:e.deviceId}})),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",[]);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),d=function(){var e=Object(o.useState)([]),t=Object(i.a)(e,2),n=t[0],r=t[1];return Object(o.useEffect)((function(){Object(c.a)(a.a.mark((function e(){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u();case 2:t=e.sent,r(t);case 4:case"end":return e.stop()}}),e)})))()}),[]),n},l=function(){var e=Object(o.useState)([]),t=Object(i.a)(e,2),n=t[0],r=t[1];return Object(o.useEffect)((function(){Object(c.a)(a.a.mark((function e(){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s();case 2:t=e.sent,r(t);case 4:case"end":return e.stop()}}),e)})))()}),[]),n}},65:function(e,t,n){},68:function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=68},69:function(e,t,n){},71:function(e,t,n){},93:function(e,t,n){},94:function(e,t,n){}}]);
//# sourceMappingURL=4.5b65ce9e.chunk.js.map