(this["webpackJsonpremote-faces-web"]=this["webpackJsonpremote-faces-web"]||[]).push([[0],{28:function(e,t,n){e.exports=n(46)},33:function(e,t,n){},34:function(e,t,n){},36:function(e,t,n){},37:function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=37},38:function(e,t,n){},39:function(e,t,n){},40:function(e,t,n){},45:function(e,t,n){},46:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),c=n(22),o=n.n(c),i=(n(33),n(23)),u=n(24),s=n(26),l=n(27),d=n(3),f=function(){var e=Object(r.useState)(30),t=Object(d.a)(e,2),n=t[0],c=t[1];return Object(r.useEffect)((function(){n>0?setTimeout((function(){c(n-1)}),1e3):window.location.reload()})),a.a.createElement("div",null,a.a.createElement("h1",null,"Unrecoverable error occurred."),a.a.createElement("p",null,"Will auto reload in ",n," sec."))},m=(n(34),n(2)),p=n.n(m),v=n(4),b=function(){var e=window.crypto.getRandomValues(new Uint8Array(32));return Array.from(e).map((function(e){return e.toString(16).padStart(2,"0")})).join("")},h=function(){return 1e3+window.crypto.getRandomValues(new Uint16Array(1))[0]%9e3},g=function(e){try{var t=new URL(e).hash.slice(1);return new URLSearchParams(t).get("roomId")}catch(n){return null}},k=(n(36),n(25)),y=n.n(k),O=function(e,t){return"".concat(e,"_").concat(t)},E=function(e){return Number(e.split("_")[1])},j=function(e){return E(e.peer)},I=function(e){var t=E(e);return 10<=t&&t<=14},w=function(e,t,n,r,a){var c=!1,o=null,i=null,u=function(){var e=new Map;return{addConn:function(t){var n=e.get(t.peer);n&&n.conn.close(),e.set(t.peer,{conn:t,mediaTypes:[]})},markConnected:function(t){var n=e.get(t.peer);n&&(n.connected=!0)},isConnected:function(t){var n=e.get(t);return n&&n.connected||!1},setUserId:function(t,n){var r=e.get(t.peer);r&&(r.userId=n)},getUserId:function(t){var n=e.get(t.peer);return n&&n.userId},setMediaTypes:function(t,n){var r=e.get(t.peer);r&&(r.mediaTypes=n)},getMediaTypes:function(t){var n=e.get(t.peer);return n&&n.mediaTypes||[]},hasConn:function(t){return e.has(t)},delConn:function(t){var n=e.get(t.peer);n&&n.conn===t&&e.delete(t.peer)},getConnectedPeerIds:function(){return Array.from(e.keys()).filter((function(t){var n;return null===(n=e.get(t))||void 0===n?void 0:n.connected}))},forEachConnectedConns:function(t){Array.from(e.values()).forEach((function(e){e.connected&&t(e.conn)}))},forEachConnsAcceptingMedia:function(t,n){Array.from(e.values()).forEach((function(e){e.connected&&e.mediaTypes&&e.mediaTypes.includes(t)&&n(e.conn)}))},clearAll:function(){e.size&&console.log("connectionMap garbage:",e),e.clear()}}}(),s=[],l=null,d=function(){if(!c){var e=u.getConnectedPeerIds().map(E);n({type:"CONNECTED_PEERS",peerIndexList:e})}},f=function(e){if(!c&&o&&o.id!==e&&!u.hasConn(e)){console.log("connectPeer",e);var t=o.connect(e,{serialization:"json"});w(t)}},m=function(e,n){if(!c){n&&(i=e);var r=u.getConnectedPeerIds();u.forEachConnectedConns((function(n){try{n.send({userId:t,data:e,peers:r,mediaTypes:s})}catch(a){console.error("broadcastData",a)}}))}},b=function(e,t){e.send({SDP:t})},g=function(){var e=Object(v.a)(p.a.mark((function e(t,n){var r,a,c;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n&&"object"===typeof n){e.next=2;break}return e.abrupt("return");case 2:if("object"!==typeof n.offer){e.next=20;break}return r=n.offer,e.prev=4,e.next=7,t.peerConnection.setRemoteDescription(r);case 7:return e.next=9,t.peerConnection.createAnswer();case 9:return a=e.sent,e.next=12,t.peerConnection.setLocalDescription(a);case 12:b(t,{answer:a}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(4),console.log("handleSDP offer failed",e.t0);case 18:e.next=33;break;case 20:if("object"!==typeof n.answer){e.next=32;break}return c=n.answer,e.prev=22,e.next=25,t.peerConnection.setRemoteDescription(c);case 25:e.next=30;break;case 27:e.prev=27,e.t1=e.catch(22),console.log("handleSDP answer failed",e.t1);case 30:e.next=33;break;case 32:console.warn("unkonwn SDP",n);case 33:case"end":return e.stop()}}),e,null,[[4,15],[22,27]])})));return function(t,n){return e.apply(this,arguments)}}(),k=function(t,n){if(!c&&(n||"object"===typeof n)){g(t,n.SDP),function(e,t){"string"===typeof t&&u.setUserId(e,t)}(t,n.userId),function(e,t){Array.isArray(t)&&t.every((function(e){return"string"===typeof e}))&&(u.setMediaTypes(e,t),setTimeout((function(){x(e)}),3e3))}(t,n.mediaTypes),Array.isArray(n.peers)&&n.peers.forEach((function(t){(function(e,t){return"string"===typeof t&&t.startsWith("".concat(e,"_"))})(e,t)&&f(t)}));var a=u.getUserId(t);if(a){var o={userId:a,peerIndex:j(t),mediaTypes:u.getMediaTypes(t)};try{r(n.data,o)}catch(i){console.error("receiveData",i)}}}},w=function(e){u.isConnected(e.peer)?e.close():(u.addConn(e),e.on("open",(function(){u.markConnected(e),d(),i&&e.send({userId:t,data:i,peers:u.getConnectedPeerIds(),mediaTypes:s})})),e.on("data",(function(t){return k(e,t)})),e.peerConnection.addEventListener("negotiationneeded",Object(v.a)(p.a.mark((function t(){var n;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(u.isConnected(e.peer)){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,e.peerConnection.createOffer();case 4:return n=t.sent,t.next=7,e.peerConnection.setLocalDescription(n);case 7:b(e,{offer:n});case 8:case"end":return t.stop()}}),t)})))),e.peerConnection.addEventListener("track",(function(t){var n=u.getUserId(e);if(n){var r={userId:n,peerIndex:E(e.peer),mediaTypes:u.getMediaTypes(e)};a(t.track,r)}})),e.on("close",(function(){if(u.delConn(e),console.log("dataConnection closed",e),n({type:"CONNECTION_CLOSED",peerIndex:j(e)}),d(),0===u.getConnectedPeerIds().length)C(!0);else if(I(e.peer)&&o&&!o.disconnected&&!I(o.id)){var t=30+Math.floor(60*Math.random());console.log("Disconnected seed peer: ".concat(E(e.peer),", reinit in ").concat(t,"sec...")),setTimeout(C,1e3*t)}})))},S=function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;if(!c&&!o){u.clearAll();var a=10<=r&&r<=14,i=a?r:h();n({type:"INITIALIZING_PEER",peerIndex:i});var s=O(e,i);console.log("initMyPeer start",r,s);var l=new y.a(s,{debug:2});o=l,l.on("open",(function(){o=l,n({type:"CONNECTING_SEED_PEERS"});for(var t=10;t<=14;t+=1){var r=O(e,t);f(r)}})),l.on("error",(function(e){"unavailable-id"===e.type?(o=null,l.destroy(),t(r+1)):"peer-unavailable"===e.type||("network"===e.type?(console.log("initMyPeer network error",r,e),l.destroy()):(console.error("initMyPeer",r,e.type,e),n({type:"UNKNOWN_ERROR"})))})),l.on("connection",(function(e){o===l?(console.log("new connection received",e),n({type:"NEW_CONNECTION",peerIndex:j(e)}),w(e)):e.close()})),l.on("disconnected",(function(){console.log("initMyPeer disconnected",r),setTimeout((function(){o!==l||l.destroyed||(console.log("initMyPeer reconnecting",r),n({type:"RECONNECTING"}),l.reconnect())}),5e3)})),l.on("close",(function(){o===l?(console.log("initMyPeer closed, re-initializing",r),o=null,setTimeout(t,1e4)):console.log("initMyPeer closed, ignoring",r)}))}};S();var C=function(t){if(o&&!o.disconnected){if(!t){if(I(o.id))return;for(var n=!0,r=10;r<=14;r+=1){var a=O(e,r);if(!u.isConnected(a)){n=!1;break}}if(n)return void d()}var c=o;o=null,c.destroy(),S()}},T=new WeakMap,x=function(e){var t=e.peerConnection.getSenders();console.log("syncTracks: senders",t.length,e);var n=u.getMediaTypes(e);l&&l.getTracks().forEach((function(r){var a=T.get(r);l&&a&&n.includes(a)&&t.every((function(e){return e.track!==r}))&&e.peerConnection.addTrack(r,l)})),t.forEach((function(t){if(t.track){var r=T.get(t.track);r&&n.includes(r)||e.peerConnection.removeTrack(t)}}))};return{broadcastData:m,acceptMediaTypes:function(e){(s=e).length?l||(l=new MediaStream):l=null,m(null)},addTrack:function(e,t){l&&(T.set(t,e),l.addTrack(t),u.forEachConnsAcceptingMedia(e,function(){var e=Object(v.a)(p.a.mark((function e(n){return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,l){e.next=3;break}return e.abrupt("return");case 3:n.peerConnection.addTrack(t,l),e.next=12;break;case 6:if(e.prev=6,e.t0=e.catch(0),"InvalidAccessError"!==e.t0.name){e.next=11;break}e.next=12;break;case 11:throw e.t0;case 12:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}()))},removeTrack:function(e,t){l&&l.removeTrack(t),u.forEachConnsAcceptingMedia(e,function(){var e=Object(v.a)(p.a.mark((function e(n){var r,a;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.peerConnection.getSenders(),(a=r.find((function(e){return e.track===t})))&&n.peerConnection.removeTrack(a);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())},dispose:function(){c=!0,o&&o.destroy()}}},S=new Map,C=function(e,t,n,r,a){var c="".concat(e,"_").concat(t),o=S.get(c);if(!o){var i=new Set,u=new Set,s=new Set;o={room:w(e,t,(function(e){i.forEach((function(t){t(e)}))}),(function(e,t){u.forEach((function(n){n(e,t)}))}),(function(e,t){s.forEach((function(n){(0,n.listener)(e,t)}))})),networkStatusListeners:i,dataListeners:u,trackListeners:s,count:0},S.set(c,o)}if(n&&o.networkStatusListeners.add(n),r&&o.dataListeners.add(r),a){var l=new Set(Array.from(o.trackListeners).map((function(e){return e.mediaType}))),d=l.size;o.trackListeners.add(a),l.add(a.mediaType),d!==l.size&&o.room.acceptMediaTypes(Array.from(l))}o.count+=1;var f=o;return{broadcastData:o.room.broadcastData,addTrack:o.room.addTrack,removeTrack:o.room.removeTrack,unregister:function(){if(n&&f.networkStatusListeners.delete(n),r&&f.dataListeners.delete(r),a){var e=new Set(Array.from(f.trackListeners).map((function(e){return e.mediaType}))),t=e.size;f.trackListeners.delete(a),t!==(e=new Set(Array.from(f.trackListeners).map((function(e){return e.mediaType})))).size&&f.room.acceptMediaTypes(Array.from(e))}f.count-=1,f.count<=0&&(f.room.dispose(),S.delete(c))}}},T=function(e,t,n){var a=Object(r.useState)(),c=Object(d.a)(a,2),o=c[0],i=c[1];if(o&&"UNKNOWN_ERROR"===o.type)throw new Error("Network Error");return Object(r.useEffect)((function(){return C(e,t,(function(e){i(e),n&&n(e)})).unregister}),[e,t,n]),o},x=function(e,t){var n=Object(r.useRef)(),a=Object(r.useCallback)((function(){n.current&&n.current.apply(n,arguments)}),[]);return Object(r.useEffect)((function(){var r=C(e,t);return n.current=r.broadcastData,r.unregister}),[e,t]),a},M=function(e,t,n){Object(r.useEffect)((function(){return C(e,t,void 0,n).unregister}),[e,t,n])},A=function(e,t,n,a){var c=Object(r.useState)({}),o=Object(d.a)(c,2),i=o[0],u=o[1];return Object(r.useEffect)((function(){if(a){var r=C(e,t,void 0,void 0,{mediaType:a,listener:n});return u({addTrack:function(e){return r.addTrack(a,e)},removeTrack:function(e){return r.removeTrack(a,e)}}),function(){u({}),r.unregister()}}}),[e,t,n,a]),i},N=function(){var e=Object(v.a)(p.a.mark((function e(){var t,n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:return t=e.sent,n=t.filter((function(e){return"videoinput"===e.kind})).map((function(e){return{label:e.label,deviceId:e.deviceId}})),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",[]);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),L=function(){var e=Object(v.a)(p.a.mark((function e(){var t,n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.enumerateDevices();case 3:return t=e.sent,n=t.filter((function(e){return"audioinput"===e.kind})).map((function(e){return{label:e.label,deviceId:e.deviceId}})),e.abrupt("return",n);case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",[]);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),D=(n(38),n(17)),R=n(11),P=function(e){return new Promise((function(t){return setTimeout(t,e)}))},U=function(){var e=Object(v.a)(p.a.mark((function e(t,n){var r,a,c,o,i,u,s,l,d,f,m;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"===typeof ImageCapture){e.next=21;break}return r=new ImageCapture(n),e.next=4,P(2e3);case 4:return e.prev=4,e.next=7,r.takePhoto();case 7:return c=e.sent,e.next=10,createImageBitmap(c);case 10:a=e.sent,e.next=18;break;case 13:return e.prev=13,e.t0=e.catch(4),e.next=17,r.grabFrame();case 17:a=e.sent;case 18:return o=a.width,i=a.height,e.abrupt("return",{srcImg:a,srcW:o,srcH:i});case 21:return(u=document.getElementById("internal-video")).style.display="block",s=u.srcObject,l=function(){u.srcObject=s},u.srcObject=t,e.next=28,P(2e3);case 28:return d=u,f=u.videoWidth,m=u.videoHeight,e.abrupt("return",{srcImg:d,srcW:f,srcH:m,revert:l});case 32:case"end":return e.stop()}}),e,null,[[4,13]])})));return function(t,n){return e.apply(this,arguments)}}(),V=function(){var e=Object(v.a)(p.a.mark((function e(t){var n,r,a,c,o,i,u,s,l,d,f,m,v,b,h,g,k;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{video:{deviceId:t}}:{video:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return r=e.sent,a=r.getVideoTracks()[0],c=document.getElementById("internal-canvas"),o=c.getContext("2d"),i=72,u=72,c.width=i,c.height=u,e.next=13,U(r,a);case 13:return s=e.sent,l=s.srcImg,d=s.srcW,f=s.srcH,m=s.revert,v=Math.max(i/d,u/f),b=Math.min(d,i/v),h=Math.min(f,u/v),g=(d-b)/2,k=(f-h)/2,o.drawImage(l,g,k,b,h,0,0,i,u),m&&m(),a.stop(),e.abrupt("return",c.toDataURL("image/png"));case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),F=n(13),_=function(){var e=Object(v.a)(p.a.mark((function e(t){var n,r,a,c,o,i,u,s,l,d,f,m,v,b,h,g;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{video:{deviceId:t}}:{video:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return r=e.sent,a=r.getVideoTracks()[0],(c=document.getElementById("internal-video")).style.display="block",c.srcObject=r,e.next=10,P(1e3);case 10:return o=c.videoWidth,i=c.videoHeight,u=document.getElementById("internal-canvas"),s=u.getContext("2d"),72,72,u.width=72,u.height=72,l=Math.max(72/o,72/i),d=Math.min(o,72/l),f=Math.min(i,72/l),m=(o-d)/2,v=(i-f)/2,b=setInterval((function(){s.drawImage(c,m,v,d,f,0,0,72,72)}),1e3/30),h=u.captureStream(),g=function(){c.style.display="none",clearInterval(b),a.stop(),h.getVideoTracks()[0].stop()},e.abrupt("return",{stream:h,dispose:g});case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),W=function(){var e=Object(v.a)(p.a.mark((function e(t){var n,r,a,c;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,(n=document.createElement("video")).srcObject=new MediaStream([t]),r=0;case 4:if(!(r<50)){e.next=14;break}return e.next=7,P(100);case 7:if(a=n.videoWidth,c=n.videoHeight,!(a>0&&c>0)){e.next=11;break}return e.abrupt("return",72===a&&72===c);case 11:r+=1,e.next=4;break;case 14:return e.abrupt("return",!0);case 17:return e.prev=17,e.t0=e.catch(0),e.abrupt("return",!0);case 20:case"end":return e.stop()}}),e,null,[[0,17]])})));return function(t){return e.apply(this,arguments)}}(),q=new WeakMap,B=function(e){if(q.has(e))return q.get(e);var t=W(e);return q.set(e,t),t},H=function(){var e=Object(v.a)(p.a.mark((function e(t){var n,r,a,c;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t?{audio:{deviceId:t}}:{audio:!0},e.next=3,navigator.mediaDevices.getUserMedia(n);case 3:return r=e.sent,a=r.getAudioTracks()[0],e.next=7,a.applyConstraints({echoCancellation:!0,echoCancellationType:{ideal:"system"},noiseSuppression:{ideal:!0}});case 7:return c=function(){a.stop()},e.abrupt("return",{stream:r,dispose:c});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),z=function(e,t){var n=t&&t.getVideoTracks()[0],r=t&&t.getAudioTracks()[0],a=new MediaStream;return a.addTrack(e),"video"===e.kind&&r?a.addTrack(r):"audio"===e.kind&&n&&a.addTrack(n),a},Y=function(e,t){var n=t&&t.getVideoTracks()[0],r=t&&t.getAudioTracks()[0],a=new MediaStream;return"video"===e.kind&&r?a.addTrack(r):"audio"===e.kind&&n&&a.addTrack(n),a.getTracks().length>0?a:null},G=a.a.memo((function(e){var t=e.image,n=e.nickname,c=e.statusMesg,o=e.obsoleted,i=e.liveMode,u=e.stream,s=e.disableAudioInput,l=e.enableAudioOutput,f=Object(r.useState)(!1),m=Object(d.a)(f,2),p=m[0],v=m[1],b=Object(r.useState)(!1),h=Object(d.a)(b,2),g=h[0],k=h[1],y=g&&!s,O=u&&u.getVideoTracks()[0],E=u&&u.getAudioTracks()[0];return Object(r.useEffect)((function(){if(O){v(!O.muted);var e=function(){return v(!1)},t=function(){return v(!0)};return O.addEventListener("mute",e),O.addEventListener("unmute",t),function(){O.removeEventListener("mute",e),O.removeEventListener("unmute",t)}}}),[O]),Object(r.useEffect)((function(){if(E){k(!E.muted);var e=function(){return k(!1)},t=function(){return k(!0)};return E.addEventListener("mute",e),E.addEventListener("unmute",t),function(){E.removeEventListener("mute",e),E.removeEventListener("unmute",t)}}}),[E]),a.a.createElement("div",{className:"FaceImages-card",style:{opacity:o?.2:1}},i&&u?a.a.createElement("video",{className:"FaceImages-photo",ref:function(e){e&&(e.srcObject=u)},autoPlay:!0,muted:!l}):a.a.createElement("img",{src:t||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQI12NgYAAAAAMAASDVlMcAAAAASUVORK5CYII=",className:"FaceImages-photo",alt:"myself"}),a.a.createElement("div",{className:"FaceImages-name"},n),a.a.createElement("div",{className:"FaceImages-mesg"},c),i&&p&&y&&a.a.createElement("div",{className:"FaceImages-live-indicator",title:"Video/Audio On"},"\u25c8"),i&&p&&!y&&a.a.createElement("div",{className:"FaceImages-live-indicator",title:"Video On"},"\u25c9"),i&&!u&&!o&&a.a.createElement("div",{className:"FaceImages-live-indicator",title:"Video On"},"\u25ce"))})),K=a.a.memo((function(e){var t=e.roomId,n=e.userId,c=e.nickname,o=e.statusMesg,i=e.liveMode,u=e.micOn,s=e.speakerOn,l=e.videoDeviceId,f=e.audioDeviceId,m=function(e,t,n,a,c,o){var i=Object(r.useState)(),u=Object(d.a)(i,2),s=u[0],l=u[1],f=Object(r.useState)([]),m=Object(d.a)(f,2),b=m[0],h=m[1],g=Object(r.useState)(),k=Object(d.a)(g,2),y=k[0],O=k[1];if(y)throw y;var E=x(e,t);return M(e,t,Object(r.useCallback)((function(e,t){if((n=e)&&"object"===typeof n&&"string"===typeof n.image&&function(e){return e&&"object"===typeof e&&"string"===typeof e.nickname&&"string"===typeof e.message&&"boolean"===typeof e.liveMode}(n.info)){var n,r=Object(R.a)({},e,{userId:t.userId,received:Date.now(),obsoleted:!1,peerIndex:t.peerIndex});h((function(e){return e.find((function(e){return e.userId===r.userId}))?e.map((function(e){return e.userId===r.userId?r:e})):[].concat(Object(D.a)(e),[r])}))}}),[])),T(e,t,Object(r.useCallback)((function(e){if(e&&"CONNECTION_CLOSED"===e.type){var t=e.peerIndex;h((function(e){var n=!1,r=e.map((function(e){return e.peerIndex===t?(n=!0,Object(R.a)({},e,{obsoleted:!0})):e}));return n?r:e}))}}),[])),Object(r.useEffect)((function(){var e=function(){var e=Date.now()-12e4,t=Date.now()-6e5;h((function(n){var r=!1,a=n.map((function(n){return n.received<e&&!n.obsoleted?(r=!0,Object(R.a)({},n,{obsoleted:!0})):n.received<t&&n.obsoleted?(r=!0,null):n})).filter((function(e){return e}));return r?a:n}))},r=function(){var r=Object(v.a)(p.a.mark((function r(){var i;return p.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,e(),r.next=4,V(o);case 4:i=r.sent,l(i),E({userId:t,image:i,info:{nickname:n,message:a,liveMode:c}},!0),r.next=15;break;case 11:r.prev=11,r.t0=r.catch(0),console.error(r.t0),O(r.t0);case 15:case"end":return r.stop()}}),r,null,[[0,11]])})));return function(){return r.apply(this,arguments)}}();r();var i=setInterval(r,12e4);return function(){clearTimeout(i)}}),[e,t,o,n,a,c,E]),{myImage:s,roomImages:b}}(t,n,c,o,i,l),b=m.myImage,h=m.roomImages,g=function(e,t,n,a,c,o,i){var u=Object(r.useState)(null),s=Object(d.a)(u,2),l=s[0],f=s[1],m=Object(r.useState)({}),b=Object(d.a)(m,2),h=b[0],g=b[1],k=Object(r.useRef)([]);Object(r.useEffect)((function(){return function(){k.current.forEach((function(e){return e()}))}}),[]);var y=Object(r.useCallback)(function(){var e=Object(v.a)(p.a.mark((function e(t,n){var r;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0="video"===t.kind,!e.t0){e.next=5;break}return e.next=4,B(t);case 4:e.t0=!e.sent;case 5:if(!e.t0){e.next=7;break}return e.abrupt("return");case 7:g((function(e){return Object(R.a)({},e,Object(F.a)({},n.userId,z(t,e[n.userId])))})),r=function(){g((function(e){return Object(R.a)({},e,Object(F.a)({},n.userId,Y(t,e[n.userId])))}))},t.addEventListener("ended",r),k.current.push((function(){t.removeEventListener("ended",r)}));case 11:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),[]),O=A(e,t,y,n?"faceVideo":void 0),E=O.addTrack,j=O.removeTrack,I=A(e,t,y,a?"faceAudio":void 0),w=I.addTrack,S=I.removeTrack;return Object(r.useEffect)((function(){var e=null;return n&&E&&j&&Object(v.a)(p.a.mark((function t(){var n,r,a,c;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,_(o);case 2:n=t.sent,r=n.stream,a=n.dispose,c=r.getVideoTracks()[0],E(c),f((function(e){return z(c,e)})),e=function(){f((function(e){return Y(c,e)})),j(c),a()};case 9:case"end":return t.stop()}}),t)})))(),function(){e&&e()}}),[e,n,o,E,j]),Object(r.useEffect)((function(){var e=null;return a&&w&&S&&Object(v.a)(p.a.mark((function t(){var n,r,a,c;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,H(i);case 2:n=t.sent,r=n.stream,a=n.dispose,c=r.getAudioTracks()[0],w(c),f((function(e){return z(c,e)})),e=function(){f((function(e){return Y(c,e)})),S(c),a()};case 9:case"end":return t.stop()}}),t)})))(),function(){e&&e()}}),[e,a,i,w,S]),Object(r.useEffect)((function(){if(l){var e=l.getAudioTracks()[0];e&&(e.enabled=c)}}),[l,c]),{faceStream:l,faceStreamMap:h}}(t,n,i,i,u,l,f),k=g.faceStream,y=g.faceStreamMap;return a.a.createElement("div",{className:"FaceImage-container"},a.a.createElement(G,{image:b,nickname:c,statusMesg:o,liveMode:i,stream:k||void 0,disableAudioInput:!u}),h.map((function(e){return a.a.createElement(G,{key:e.userId,image:e.image,nickname:e.info.nickname,statusMesg:e.info.message,obsoleted:e.obsoleted,liveMode:e.info.liveMode,stream:y[e.userId]||void 0,enableAudioOutput:s})})))})),J=(n(39),function(e,t){var n=t[1]-e[1];return 0===n?e[0].length-t[0].length:n}),Q=["\ud83d\udc4d","\u2764\ufe0f","\ud83d\ude01","\ud83d\ude0e","\ud83e\udd23"],Z=function(e){var t=e.text,n=e.onClick;return a.a.createElement("button",{type:"button",onClick:function(){return n(t)}},a.a.createElement("span",{"aria-label":"Reaction"},t))},$=a.a.memo((function(e){var t=e.chatList,n=e.replyChat;return a.a.createElement("ul",{className:"MomentaryChat-list"},t.map((function(e){var t=function(t){return n(t,e.replyTo)};return a.a.createElement("li",{key:e.key,className:"MomentaryChat-listPart"},a.a.createElement("div",{className:"MomentaryChat-listPart-header"},a.a.createElement("div",{className:"MomentaryChat-iconButton-container"},a.a.createElement("div",{className:"MomentaryChat-iconButton"},Q.map((function(e){return a.a.createElement(Z,{key:e,text:e,onClick:t})})))),a.a.createElement("div",{className:"MomentaryChat-nickname"},e.nickname||"No Name")),a.a.createElement("div",null,e.text),e.replies.map((function(e){var t=Object(d.a)(e,2),n=t[0],r=t[1];return a.a.createElement("div",{className:"Momentary-icon"},n," ",r)})))})))})),X=a.a.memo((function(e){var t=function(e,t,n){var a=Object(r.useRef)(1),c=Object(r.useRef)(new Map),o=Object(r.useState)([]),i=Object(d.a)(o,2),u=i[0],s=i[1],l=Object(r.useCallback)((function(e){if((c.current.get(e.userId)||0)<e.chatSeq)if(c.current.set(e.userId,e.chatSeq),e.chatInReplyTo){var t=e.chatText,n=e.chatInReplyTo;s((function(e){return e.map((function(e){if(e.replyTo.userId===n.userId&&e.replyTo.chatSeq===n.chatSeq){var r=new Map(e.replies);r.set(t,(r.get(t)||0)+1);var a=Object(D.a)(r.entries());return a.sort(J),Object(R.a)({},e,{replies:a})}return e}))}))}else{var r={key:"".concat(e.userId,"_").concat(e.chatSeq),replyTo:{userId:e.userId,chatSeq:e.chatSeq},nickname:e.nickname,text:e.chatText,replies:[]};s((function(e){return[r].concat(Object(D.a)(e)).slice(0,100)}))}}),[]),f=x(e,t);return M(e,t,Object(r.useCallback)((function(e){var t;!(t=e)||"object"!==typeof t||"string"!==typeof t.userId||"string"!==typeof t.nickname||"number"!==typeof t.chatSeq||"string"!==typeof t.chatText||"undefined"!==typeof t.chatInReplyTo&&"string"!==typeof t.chatInReplyTo.userId&&"number"!==typeof t.chatInReplyTo.chatSeq||l(e)}),[l])),{chatList:u,sendChat:Object(r.useCallback)((function(e){var r={userId:t,nickname:n,chatSeq:a.current,chatText:e};a.current+=1,f(r),l(r)}),[f,t,n,l]),replyChat:Object(r.useCallback)((function(e,r){var c={userId:t,nickname:n,chatSeq:a.current,chatText:e,chatInReplyTo:r};a.current+=1,f(c),l(c)}),[f,t,n,l])}}(e.roomId,e.userId,e.nickname),n=t.chatList,c=t.sendChat,o=t.replyChat,i=Object(r.useState)(""),u=Object(d.a)(i,2),s=u[0],l=u[1];return a.a.createElement("div",{className:"MomentaryChat-container"},a.a.createElement("form",{onSubmit:function(e){e.preventDefault(),s&&(c(s),l(""))}},a.a.createElement("input",{value:s,onChange:function(e){return l(e.target.value)},placeholder:"Enter chat message"}),a.a.createElement("button",{type:"submit",disabled:!s},"Send")),a.a.createElement($,{chatList:n,replyChat:o}))})),ee=(n(40),function(){var e=Object(v.a)(p.a.mark((function e(){var t,n,r,a;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t={video:!0},e.next=4,navigator.mediaDevices.getDisplayMedia(t);case 4:return n=e.sent,r=n.getVideoTracks()[0],a=function(){r.stop()},e.abrupt("return",{stream:n,dispose:a});case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",null);case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(){return e.apply(this,arguments)}}()),te=function(){var e=Object(v.a)(p.a.mark((function e(t){var n;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("video"===t.kind){e.next=2;break}return e.abrupt("return",!1);case 2:return e.next=4,B(t);case 4:return n=e.sent,e.abrupt("return",!n);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ne=a.a.memo((function(e){var t=e.nickname,n=e.stream,c=Object(r.useRef)(null);return Object(r.useEffect)((function(){n&&c.current&&(c.current.srcObject=n)}),[n]),a.a.createElement("div",null,a.a.createElement("div",{className:"ScreenShare-nickname"},t),a.a.createElement("video",{className:"ScreenShare-video",ref:c,autoPlay:!0,muted:!0}))})),re=a.a.memo((function(e){var t=e.roomId,n=e.userId,c=e.nickname,o=Object(r.useState)(!1),i=Object(d.a)(o,2),u=i[0],s=i[1],l=function(e,t,n,a){var c=Object(r.useState)(null),o=Object(d.a)(c,2),i=o[0],u=o[1],s=Object(r.useState)({}),l=Object(d.a)(s,2),f=l[0],m=l[1],b=Object(r.useRef)([]);Object(r.useEffect)((function(){return function(){b.current.forEach((function(e){return e()}))}}),[]);var h=Object(r.useCallback)(function(){var e=Object(v.a)(p.a.mark((function e(t,n){var r,a,c,o;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,te(t);case 2:if(e.sent){e.next=4;break}return e.abrupt("return");case 4:m((function(e){return Object(R.a)({},e,Object(F.a)({},n.userId,new MediaStream([t])))})),r=function(){m((function(e){return Object(R.a)({},e,Object(F.a)({},n.userId,null))}))},t.addEventListener("ended",r),c=function(){clearTimeout(a),a=setTimeout((function(){m((function(e){return Object(R.a)({},e,Object(F.a)({},n.userId,null))}))}),3e3)},t.addEventListener("mute",c),o=function(){clearTimeout(a)},t.addEventListener("unmute",o),b.current.push((function(){t.removeEventListener("ended",r),clearTimeout(a),t.removeEventListener("mute",c),t.removeEventListener("unmute",o)}));case 12:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),[]),g=A(e,t,h,"screenVideo"),k=g.addTrack,y=g.removeTrack;return Object(r.useEffect)((function(){var e=null;return n&&k&&y&&Object(v.a)(p.a.mark((function t(){var n,r;return p.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ee();case 2:if(n=t.sent){t.next=6;break}return a(!1),t.abrupt("return");case 6:(r=n.stream.getVideoTracks()[0]).contentHint="screen",k(r),u(n.stream),e=function(){y(r),n.dispose(),u(null),a(!1)},r.addEventListener("ended",(function(){e&&e(),e=null}));case 12:case"end":return t.stop()}}),t)})))(),function(){e&&e()}}),[e,n,a,k,y]),{screenStream:i,screenStreamMap:f}}(t,n,u,s),f=l.screenStream,m=l.screenStreamMap,b=function(e,t){var n=Object(r.useState)({}),a=Object(d.a)(n,2),c=a[0],o=a[1];return M(e,t,Object(r.useCallback)((function(e,t){var n;(n=e)&&"object"===typeof n&&"string"===typeof n.image&&function(e){return e&&"object"===typeof e&&"string"===typeof e.nickname&&"string"===typeof e.message}(n.info)&&o((function(n){return Object(R.a)({},n,Object(F.a)({},t.userId,e.info.nickname))}))}),[])),c}(t,n);return a.a.createElement("div",{className:"ScreenShare-container"},a.a.createElement("button",{type:"button",onClick:function(){return s(!u)}},u?"Stop screen share":"Start screen share"),f&&a.a.createElement(ne,{nickname:c,stream:f}),Object.keys(m).map((function(e){var t=m[e];return t?a.a.createElement(ne,{key:e,nickname:b[e]||"No Name",stream:t}):null})))})),ae=(n(41),n(19)),ce=function(e){try{return window.localStorage.getItem(e)||""}catch(t){return""}}("nickname"),oe=a.a.memo((function(e){var t=e.initialText,n=e.onUpdate,c=e.buttonLabel,o=e.placeholder,i=e.clearOnUpdate,u=Object(r.useState)(t),s=Object(d.a)(u,2),l=s[0],f=s[1];return a.a.createElement("form",{onSubmit:function(e){e.preventDefault(),l&&(n(l),i&&f(""))}},a.a.createElement("input",{value:l,onChange:function(e){return f(e.target.value)},placeholder:o}),c&&a.a.createElement("button",{type:"submit",disabled:!l},c))})),ie=function(e){var t=e.roomId,n=e.userId,c=Object(r.useState)(ce),o=Object(d.a)(c,2),i=o[0],u=o[1],s=Object(r.useState)(""),l=Object(d.a)(s,2),f=l[0],m=l[1],b=Object(r.useState)(null),h=Object(d.a)(b,2),g=h[0],k=h[1],y=Object(r.useState)(!1),O=Object(d.a)(y,2),E=O[0],j=O[1];Object(r.useEffect)((function(){!function(e){var t=window.location.hash.slice(1),n=new URLSearchParams(t);n.set("roomId",e),window.location.hash=n.toString()}(t)}),[t]);var I=function(){var e=Object(r.useState)([]),t=Object(d.a)(e,2),n=t[0],a=t[1];return Object(r.useEffect)((function(){Object(v.a)(p.a.mark((function e(){var t;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:t=e.sent,a(t);case 4:case"end":return e.stop()}}),e)})))()}),[]),n}(),w=function(){var e=Object(r.useState)([]),t=Object(d.a)(e,2),n=t[0],a=t[1];return Object(r.useEffect)((function(){Object(v.a)(p.a.mark((function e(){var t;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,L();case 2:t=e.sent,a(t);case 4:case"end":return e.stop()}}),e)})))()}),[]),n}(),S=Object(r.useState)(),C=Object(d.a)(S,2),x=C[0],M=C[1],A=Object(r.useState)(),D=Object(d.a)(A,2),R=D[0],P=D[1],U=Object(r.useState)(!1),V=Object(d.a)(U,2),F=V[0],_=V[1],W=Object(r.useState)(!1),q=Object(d.a)(W,2),B=q[0],H=q[1],z=Object(r.useState)(!1),Y=Object(d.a)(z,2),G=Y[0],J=Y[1],Q=Object(r.useState)(!1),Z=Object(d.a)(Q,2),$=Z[0],ee=Z[1],te=Object(r.useState)(!0),ne=Object(d.a)(te,2),ie=ne[0],ue=ne[1],se=T(t,n),le="remote-faces://".concat(window.location.href.replace(/^https:\/\//,""));return a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"SingleRoom-status"},JSON.stringify(se)),a.a.createElement("div",{className:"SingleRoom-room-info"},ie?a.a.createElement(a.a.Fragment,null,a.a.createElement("button",{type:"button",onClick:function(){return ue(!1)}},"Hide config"),a.a.createElement("div",null,"Link to this room:",a.a.createElement("input",{value:window.location.href,readOnly:!0}),"(Share this link with your colleagues)",a.a.createElement("a",{href:le},"Open App")),a.a.createElement("div",{className:"SingleRoom-nickname"},"Your Name:"," ",a.a.createElement(oe,{initialText:ce,onUpdate:function(e){u(e),function(e,t){try{window.localStorage.setItem(e,t)}catch(n){console.log("Failed to save string to localStorage",n)}}("nickname",e)},placeholder:"Enter your name",buttonLabel:"Set"})),a.a.createElement("div",{className:"SingleRoom-statusmesg"},"Your Status:"," ",a.a.createElement(oe,{initialText:"",onUpdate:function(e){m(e)},placeholder:"Enter status message",buttonLabel:"Set"})),a.a.createElement("div",{className:"SingleRoom-emoji"},"Your Emoji:"," ",a.a.createElement("button",{type:"button",onClick:function(){j(!E)}},g?a.a.createElement(ae.a,{emoji:g,size:16}):"(Not Set)"),a.a.createElement("button",{type:"button",onClick:function(){k(null),j(!1)}},"Clear")),E&&a.a.createElement(ae.b,{onSelect:function(e){(function(t){try{return"string"===typeof t.id}catch(e){return!1}})(e)&&k(e),j(!1)}}),a.a.createElement("div",null,"Select Camera:"," ",a.a.createElement("select",{onChange:function(e){return M(e.target.value)}},I.map((function(e){return a.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),a.a.createElement("div",null,"Select Mic:"," ",a.a.createElement("select",{onChange:function(e){return P(e.target.value)}},w.map((function(e){return a.a.createElement("option",{key:e.deviceId,value:e.deviceId},e.label)})))),a.a.createElement("div",null,"Live Mode:"," ",a.a.createElement("button",{type:"button",onClick:function(){return _((function(e){return!e}))}},F?"Disable Live Mode (currently on)":"Enable Live Mode (currently off)"),F&&a.a.createElement(a.a.Fragment,null,a.a.createElement("label",null,a.a.createElement("input",{type:"checkbox",checked:B,onChange:function(e){return H(e.target.checked)}}),"Mic On"),a.a.createElement("label",null,a.a.createElement("input",{type:"checkbox",checked:G,onChange:function(e){return J(e.target.checked)}}),"Speaker On"))),a.a.createElement("div",null,"Screen Share:"," ",a.a.createElement("button",{type:"button",onClick:function(){return ee((function(e){return!e}))}},$?"Disable Screen Share (currently on)":"Enable Screen Share (currently off)"))):a.a.createElement("button",{type:"button",onClick:function(){return ue(!0)}},"Show config")),a.a.createElement(K,{roomId:t,userId:n,videoDeviceId:x,audioDeviceId:R,nickname:i,statusMesg:"".concat((null===g||void 0===g?void 0:g.native)||"").concat(f),liveMode:F,micOn:B,speakerOn:G}),a.a.createElement(X,{roomId:t,userId:n,nickname:i}),$&&a.a.createElement(re,{roomId:t,userId:n,nickname:i}))},ue=function(){var e=window.location.hash.slice(1);return new URLSearchParams(e).get("roomId")}(),se=b(),le=function(){var e=Object(r.useState)(ue),t=Object(d.a)(e,2),n=t[0],c=t[1],o=Object(r.useState)(""),i=Object(d.a)(o,2),u=i[0],s=i[1];return n?a.a.createElement(ie,{roomId:n,userId:se}):a.a.createElement("div",{className:"SingleRoomEntrance-init"},a.a.createElement("button",{type:"button",onClick:function(){c(b())}},"Create a new room"),"OR",a.a.createElement("input",{value:u,onChange:function(e){return s(e.target.value)},placeholder:"Enter room link..."}),a.a.createElement("button",{type:"button",onClick:function(){c(g(u))},disabled:!g(u)},"Enter room"))},de=(n(45),function(e){Object(l.a)(n,e);var t=Object(s.a)(n);function n(){var e;Object(i.a)(this,n);for(var r=arguments.length,a=new Array(r),c=0;c<r;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).state={hasError:!1},e}return Object(u.a)(n,[{key:"render",value:function(){var e=this.props.children;return this.state.hasError?a.a.createElement(f,null):e}}],[{key:"getDerivedStateFromError",value:function(){return{hasError:!0}}}]),n}(a.a.Component)),fe=function(){return a.a.createElement("div",{className:"App"},a.a.createElement(de,null,a.a.createElement(le,null)))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(a.a.createElement(a.a.StrictMode,null,a.a.createElement(fe,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[28,1,2]]]);
//# sourceMappingURL=main.6c713b21.chunk.js.map